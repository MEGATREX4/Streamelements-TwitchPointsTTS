<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–∞–≥–æ—Ä–æ–¥–∏ Twitch TTS</title>
</head>
<body>
    <script>
// –ü–∞—Ä–∞–º–µ—Ç—Ä–∏
var channelId = "174860188"; // —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –≤–∞—à–æ–≥–æ –∫–∞–Ω–∞–ª—É Twitch
var currentUsername = "test_user"; // –ó–º—ñ–Ω–Ω–∞ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ —ñ–º–µ–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
var customtext = " –∫–∞–∂–µ "; // –ö–∞–∂–µ –º–æ–∂–Ω–∞ –∑–∞–º—ñ–Ω–∏—Ç–∏ –Ω–∞ –±—É–¥—å —â–æ –±—É–¥–µ –≤–∏–≥–ª—è–¥–∞—Ç–∏ —Ç–∞–∫ [–Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞] + [—Ü—è –∑–º—ñ–Ω–Ω–∞] + [—Ç–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è]
var canStop = true; // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –∑—É–ø–∏–Ω–∫–∏ TTS

// –ù–∞–≥–æ—Ä–æ–¥–∏
var rewards = {
    "–ü–æ–≥–æ–≤–æ—Ä–∏ –º–µ–Ω—ñ —â–µ üò°": {
        // –Ω–∞–∑–≤–∞ –≤–∏–Ω–∞–≥–æ—Ä–æ–¥–∏ (–º–∞—î –∑–±—ñ–≥–∞—Ç–∏—Å—è –∑ –Ω–∞–∑–≤–æ—é –≤–∏–Ω–∞–≥–æ—Ä–æ–¥–∏ —É Twitch –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —Ä–µ–≥—ñ—Å—Ç—Ä—É)
        ttsCharacterLimit: 500, // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Å–∏–º–≤–æ–ª—ñ–≤ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
        type: "streamelements", // —Ü–µ –Ω–µ —á—ñ–ø–∞–π—Ç–µ
        voiceId: "uk-UA-Wavenet-A", // —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –≥–æ–ª–æ—Å—É, –º–æ–∂–µ—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏ –Ω–∞ —ñ–Ω—à—É –º–æ–≤—É, –∞–ª–µ —Ü–µ–π –≥–æ–≤–æ—Ä–∏—Ç—å —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é —Ç–∞ –ª–∞—Ç–∏–Ω–∫–æ—é/–∞–Ω–≥–ª—ñ–π—Å—å–∫–æ—é
        volume: 0.40, // –≥—É—á–Ω—ñ—Å—Ç—å –≤–∏–º—ñ—Ä—é—î—Ç—å—Å—è 0.0 - 1.0
    },
    "–ó—É–ø–∏–Ω–∏ TTS": {
        // –Ω–∞–≥–æ—Ä–æ–¥–∞ –¥–ª—è –∑—É–ø–∏–Ω–∫–∏ TTS
        type: "stop",
    },
};

// -----------------
// –ü–ê–†–ê–ú–ï–¢–†–ò –ù–ê–õ–ê–ì–û–î–ñ–ï–ù–ù–Ø
// -----------------
var testTTSOnLoad = true;
// —Ä–µ–∂–∏–º –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è. true = F5 –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É
// false = –Ω—ñ—á–æ–≥–æ. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è false, —è–∫—â–æ –≤–∏ –Ω–µ –ø–ª–∞–Ω—É—î—Ç–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –∫–æ–¥.

var testTTS = "–ü–æ–≥–æ–≤–æ—Ä–∏ –º–µ–Ω—ñ —â–µ üò°"; // –Ω–∞–∑–≤–∞ –Ω–∞–≥–æ—Ä–æ–¥–∏
var testText = "–ë–æ—Ç –ø—Ä–∞—Ü—é—î"; // —Ç–µ–∫—Å—Ç –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏

function sleep(miliseconds) {
    return new Promise((res) => setTimeout(res, miliseconds));
}

let currentAudioSource = null; // –¢—Ä–∏–º–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –ø–æ—Ç–æ—á–Ω–µ –∞—É–¥—ñ–æ–¥–∂–µ—Ä–µ–ª–æ
let stopTTS = false; // –ó–º—ñ–Ω–Ω–∞ –¥–ª—è –∑—É–ø–∏–Ω–∫–∏ TTS

async function textToSpeech(reward, text) {
    if (reward.type === "stop") {
        if (canStop && currentAudioSource) {
            currentAudioSource.stop();
            currentAudioSource = null;
            console.log("TTS –∑—É–ø–∏–Ω–µ–Ω–æ");
        }
        return;
    }

    const ctx = new AudioContext();

    // Limit text length
    text = text.substring(0, reward["ttsCharacterLimit"]);

    console.log("–¢–µ–∫—Å—Ç TTS:", text);

    let url;
    let requestOptions;
    let sendText = text; // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ sendText –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–º —Ç–µ–∫—Å—Ç–æ–º

    if (currentUsername !== "") {
        // –£–º–æ–≤–Ω–æ –∑–º—ñ–Ω–∏—Ç–∏ sendText –Ω–∞ –æ—Å–Ω–æ–≤—ñ –≤–∞—à–∏—Ö –≤–∏–º–æ–≥
        sendText = `${sendText}`;
    }

    if (reward["type"] == "streamelements") {
        url = `https://api.streamelements.com/kappa/v2/speech?voice=${reward["voiceId"]}&text=${sendText}`;
    } else {
        throw "–¢–∏–ø TTS –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ";
    }

    // fetch() –ø–æ–≤–µ—Ä—Ç–∞—î –æ–±—ñ—Ü—è–Ω–∫—É, —â–æ
    // –≤–∏—Ä—ñ—à—É—î—Ç—å—Å—è –ø—ñ—Å–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤
    var response = await fetch(url, requestOptions);

    var arrayBuffer = await response.arrayBuffer();
    var decodedAudio = await ctx.decodeAudioData(arrayBuffer);
    var gainNode = ctx.createGain();
    gainNode.connect(ctx.destination);
    gainNode.gain.value = reward["volume"];
    const audio = decodedAudio;
    const source = ctx.createBufferSource();
    source.buffer = audio;
    source.connect(gainNode);
    currentAudioSource = source; // –ó–±–µ—Ä–µ–≥—Ç–∏ –ø–æ—Ç–æ—á–Ω–µ –∞—É–¥—ñ–æ–¥–∂–µ—Ä–µ–ª–æ
    source.start();
    return new Promise((resolve, reject) => {
        source.onended = () => {
            currentAudioSource = null; // –°–∫–∏–Ω—É—Ç–∏ –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
            resolve();
        };
        source.onended = () => {
            if (stopTTS) {
                currentAudioSource = null; // –°–∫–∏–Ω—É—Ç–∏ –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
                stopTTS = false; // –°–∫–∏–Ω—É—Ç–∏ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å –∑—É–ø–∏–Ω–∫–∏
                resolve();
            } else {
                resolve();
            }
        };
    });
}

window.onload = () => {
    let ws = undefined;
    let pong = false;
    let interval = false;

    let notifications = [];

    (async () => {
        while (true) {
            if (notifications.length > 0) {
                let notif = notifications.pop();
                console.log("–†–æ–∑–ø–æ—á–∞—Ç–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è", notif);

                let reward = rewards[notif.title];
                if (reward && notif.text != "") {
                    console.log("–ü—Ä–æ–≥—Ä–∞—î—Ç—å—Å—è TTS");
                    try {
                        await textToSpeech(reward, notif.text);
                        console.log("TTS –∑–∞–∫—ñ–Ω—á–µ–Ω–æ");
                    } catch (e) {
                        console.log("–ü–æ–º–∏–ª–∫–∞ TTS:", e);
                    }
                }
                console.log("–ó–∞–∫—ñ–Ω—á–µ–Ω–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è");
            }
            await sleep(1000);
        }
    })();

    function connect() {
        ws = new WebSocket("wss://pubsub-edge.twitch.tv");
        listen();
    }
    function disconnect() {
        if (interval) {
            clearInterval(interval);
            interval = false;
        }
        ws.close();
    }

    function listen() {
        ws.onmessage = (a) => {
            let o = JSON.parse(a.data);
            switch (o.type) {
                case "PING":
                    ws.send(
                        JSON.stringify({
                            type: "PONG",
                        })
                    );
                    break;
                case "PONG":
                    pong = true;
                    break;
                case "RECONNECT":
                    disconnect();
                    connect();
                    break;
                case "RESPONCE":
                    console.log("–í—ñ–¥–ø–æ–≤—ñ–¥—å PubSub ", o.error);
                    break;
                case "MESSAGE":
                    switch (o.data.topic) {
                        case `community-points-channel-v1.${channelId}`:
                            let msg = JSON.parse(o.data.message);
                            console.log(msg);
                            switch (msg.type) {
                                case "reward-redeemed":
                                    let reward = msg.data.redemption.reward;
                                    currentUsername = msg.data.redemption.user.display_name;

                                    let notif = {
                                        title: reward.title,
                                        price: reward.cost,
                                        user: msg.data.redemption.user.display_name,
                                        // –í–∫–ª—é—á–∞—î–º–æ —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ —Ç–µ–∫—Å—Ç
                                        text: `${currentUsername}${customtext}${msg.data.redemption.user_input}`, 
                                    };
                                    console.log("–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ —á–µ—Ä–∑—ñ ", notif);
                                    console.log("–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á ", currentUsername);
                                    
                                    // –ù–µ–≥–∞–π–Ω–∞ –æ–±—Ä–æ–±–∫–∞ "–ó—É–ø–∏–Ω–∏ TTS"
                                    if (notif.title === "–ó—É–ø–∏–Ω–∏ TTS" && canStop) {
                                        stopTTS = true;
                                        if (currentAudioSource) {
                                            currentAudioSource.stop();
                                            currentAudioSource = null;
                                            console.log("TTS –∑—É–ø–∏–Ω–µ–Ω–æ");
                                        }
                                    } else {
                                        notifications.push(notif);
                                    }
                                    break;
                            }
                            break;
                    }
                    break;
            }
        };
        ws.onopen = () => {
            if (testTTSOnLoad) {
                let notif = {
                    title: testTTS,
                    price: 5000,
                    user: "test_user",
                    text: currentUsername + customtext + testText,
                };
                console.log("–°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤ —á–µ—Ä–∑—ñ", notif);
                notifications.push(notif);
            }

            ws.send(
                JSON.stringify({
                    type: "LISTEN",
                    nonce: "pepega",
                    data: {
                        topics: ["community-points-channel-v1." + channelId],
                        auth_token: "",
                    },
                })
            );
            interval = setInterval(async () => {
                ws.send(
                    JSON.stringify({
                        type: "PING",
                    })
                );
                await sleep(5000);
                if (pong) {
                    pong = false;
                } else {
                    pong = false;
                    disconnect();
                    connect();
                }
            }, 5 * 60 * 1000);
        };
    }

    connect();
};

</script>
</body>
</html>
